<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Turn Games</title>

	<style>
body {
	margin: 0;
}

main {
	max-width: 500px;
	height: 500px;
	margin-inline: auto;
}

#log {
	font-family: system-ui, sans-serif;
	background: #fdfdfd;
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 12px;
	height: 100%;
	overflow-y: auto;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

#log::-webkit-scrollbar { width: 8px; }
#log::-webkit-scrollbar-track { background: #eee; }
#log::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.log-entry {
	background: #fff;
	border: 1px solid #eee;
	border-radius: 6px;
	padding: 10px;
	box-shadow: 0 1px 2px rgba(0,0,0,.05);
}

.log-msg { font-weight: 600; margin-bottom: 6px; }

.log-options button {
	background: #f0f0f0;
	border: 1px solid #d7d7d7;
	padding: 4px 10px;
	border-radius: 4px;
	cursor: pointer;
	transition: .15s;
}

.log-options button:hover:not(.selected) { background: #e5e5e5; }
.log-options button.selected { background: #bbb; color: #fff; }

#log {
	box-sizing: border-box;
	padding-bottom: 200px;
}

	</style>
</head>
<body>
	<main>
		<div id="log">
		</div>
	</main>
	<script>



class StateMachine {
	constructor() {
		this._events = {};
		this._choices = [];
		this._states = {};
	}

	on(evt, fn) {
		(this._events[evt] ??= []).push(fn);
	}

	emit(evt) {
		(this._events[evt.type] ??= []).forEach(fn => fn(evt));
	}

	msg(text){
		this.emit({
			type:"msg",
			text:text,
		})
	}
	
	decision(options) {
		this._choices = options.filter(o => !o.omit);
		this.emit({
			type: "choice",
			labels: this._choices.map(o => o.label),
		});
	}

	choose(i) {
		const c = this._choices[i];
		this._choices = [];
		if(c) c.run();
	}
	
	setup(){}
}

</script><script src="game_impl.js"></script><script>

function connect(sm){
	const el_log = document.getElementById("log");
	sm.on("msg",(evt)=>{
		const el = document.createElement("div");
		el.classList.add("log-entry");
		el.innerText = evt.text;

		el_log.appendChild(el);
		el_log.scrollTo({
			top: el_log.scrollHeight,
			behavior: "smooth",
		});
	});
	sm.on("choice",(evt)=>{
		const el = document.createElement("div");
		el.classList.add("log-options");
		const buttons = evt.labels.map((txt,idx)=>{
			const btn = document.createElement("button");
			btn.innerText = txt;
			return btn;
		});
		buttons.forEach((btn,idx) => {
			btn.addEventListener("click",()=>{
				btn.classList.add("selected");
				buttons.forEach(b=>{
					b.disabled = true;
				});
				sm.choose(idx);
			})
			el.appendChild(btn);
		});
		el_log.appendChild(el);
		el_log.scrollTo({
			top: el_log.scrollHeight,
			behavior: "smooth",
		});
	})
}

var game = new TombOfFourKings();
connect(game);
game.setup();

	</script>
</body>
</html>